<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Storm Calculator: CAPE Efficiency</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 2rem;
      background-color: #f0f8ff;
      line-height: 1.6;
    }
    .container {
      background: #fff;
      padding: 2rem;
      border-radius: 10px;
      max-width: 800px;
      margin: auto;
      box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.1);
    }
    h1, h2, h3 {
      text-align: center;
      color: #333;
    }
    label {
      display: block;
      margin-top: 1.2rem;
      color: #333;
    }
    input[type="number"] {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    .unknown-option {
      font-size: 0.9rem;
      margin-top: 0.3rem;
    }
    button {
      display: block;
      width: 100%;
      padding: 0.8rem;
      background: #007acc;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 1.5rem;
      transition: background 0.3s;
    }
    button:hover {
      background: #005fa3;
    }
    .result {
      margin-top: 1.5rem;
      padding: 1.2rem;
      background: #e9f5ff;
      border: 1px solid #b3d7ff;
      border-radius: 8px;
    }
    .formula {
      background: #eef;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-family: monospace;
      display: inline-block;
      margin: 0.2rem 0;
    }
    .info, .geo-info {
      background: #fff8dc;
      padding: 1rem;
      border: 1px solid #f4e1a1;
      border-radius: 8px;
      margin-top: 1.5rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Storm Calculator</h1>
    <h2>Dynamic CAPE Efficiency & Missing Parameter Solver</h2>
    <div class="info">
      <p><strong>Instructions:</strong> Enter <em>exactly two</em> of the three primary inputs below (CAPE, Bulk Wind Shear in knots, and Storm Tilt Angle in degrees). Optionally, enter the lightning strikes per minute. For any parameter you don’t know, check its “Unknown” box. The script will compute the missing parameter and the CAPE efficiency (<em>α</em>), capped at 90%.<br><br>
      The underlying relationships are assumed to be:
      </p>
      <p class="formula">
        w = α × √(2 × CAPE) × D
      </p>
      <p>
        and
      </p>
      <p class="formula">
        Uₑff = w × tan(θ)
      </p>
      <p>
        (Note: Bulk wind shear is taken here as Uₑff in knots.)  
        If CAPE is provided, the storm height is computed as: <br>
        stormHeight = 4000 + 2×√(CAPE) (in meters). Otherwise, a default storm height of 4000 m is assumed.
      </p>
    </div>

    <!-- Primary Inputs -->
    <label for="cape">CAPE (J/kg):</label>
    <input type="number" id="cape" placeholder="e.g. 2000" step="any" />
    <label class="unknown-option"><input type="checkbox" id="capeUnknown"> Unknown</label>

    <label for="shear">Bulk Wind Shear (knots):</label>
    <input type="number" id="shear" placeholder="e.g. 30" step="any" />
    <label class="unknown-option"><input type="checkbox" id="shearUnknown"> Unknown</label>

    <label for="angle">Storm Tilt Angle (θ in degrees):</label>
    <input type="number" id="angle" placeholder="e.g. 25" step="any" />
    <label class="unknown-option"><input type="checkbox" id="angleUnknown"> Unknown</label>

    <label for="strikes">Lightning Strikes per Minute:</label>
    <input type="number" id="strikes" placeholder="e.g. 50" step="1" />

    <!-- Optional Geographic Data -->
    <div class="geo-info">
      <h3>Geographic Data (Optional)</h3>
      <label for="stormLat">Storm Latitude (°):</label>
      <input type="number" id="stormLat" placeholder="e.g. 40.0" step="any" />
      <label class="unknown-option"><input type="checkbox" id="stormLatUnknown"> Unknown</label>

      <label for="stormLon">Storm Longitude (°):</label>
      <input type="number" id="stormLon" placeholder="e.g. -80.0" step="any" />
      <label class="unknown-option"><input type="checkbox" id="stormLonUnknown"> Unknown</label>

      <label for="observerLat">Observer Latitude (°):</label>
      <input type="number" id="observerLat" placeholder="e.g. 38.5" step="any" />
      <label class="unknown-option"><input type="checkbox" id="observerLatUnknown"> Unknown</label>

      <label for="observerLon">Observer Longitude (°):</label>
      <input type="number" id="observerLon" placeholder="e.g. -77.0" step="any" />

      <label for="elevAngle">Elevation Angle from Observer (°):</label>
      <input type="number" id="elevAngle" placeholder="e.g. 10" step="any" />
      <label class="unknown-option"><input type="checkbox" id="elevAngleUnknown"> Unknown</label>
    </div>

    <button id="calcButton">Calculate</button>

    <!-- Results -->
    <div id="result" class="result" style="display:none;">
      <h3>Results</h3>
      <p>
        <strong>CAPE:</strong> <span id="capeVal"></span> J/kg<br>
        <strong>Shear:</strong> <span id="shearVal"></span> knots<br>
        <strong>Angle (θ):</strong> <span id="angleVal"></span> °<br>
        <strong>Efficiency (α):</strong> <span id="efficiency"></span><br>
        <strong>Storm Height:</strong> <span id="heightVal"></span> m<br>
        <strong>Rotational Shear Contribution:</strong> <span id="rotationShear"></span>
      </p>
      <p><strong>Effective Updraft Speed (w):</strong></p>
      <ul>
        <li><span id="updraft_mps"></span> m/s</li>
        <li><span id="updraft_knots"></span> knots</li>
        <li><span id="updraft_kmph"></span> km/h</li>
      </ul>
      <p id="explanation"></p>
    </div>
  </div>

  <script>
    /************************************************************
     * Constants & Helper Functions
     ************************************************************/
    const mpsToKnots = 1.94384;
    const mpsToKmph = 3.6;
    const dragCoefficient = 0.8;
    const dragScalingConstant = 1e6;
    const seaLevelAirDensity = 1.225;
    const T0 = 288.15;
    const L = 0.0065;
    const g = 9.80665;
    const R = 287.058;
    const Omega = 7.2921e-5; // Earth's rotation rate in rad/s

    function degToRad(deg) {
      return deg * (Math.PI / 180);
    }
    function radToDeg(rad) {
      return rad * (180 / Math.PI);
    }
    function round(value, decimals) {
      return Number(Math.round(value + "e" + decimals) + "e-" + decimals);
    }

    // Compute air density at a given height (meters)
    function calculateAirDensity(height) {
      const T = T0 - L * height;
      if (T <= 0) return 0;
      const exponent = (g / (R * L)) - 1;
      return seaLevelAirDensity * Math.pow((T / T0), exponent);
    }

    // Compute storm height from CAPE (if available)
    function calculateStormHeight(cape) {
      return 4000 + 2 * Math.sqrt(cape);
    }

    // Compute effective updraft based on CAPE, efficiency, and drag factor.
    function computeEffectiveUpdraft(cape, efficiency) {
      let wIdeal, stormHeight, airDensity, dragFactor;
      if (cape !== undefined) {
        wIdeal = Math.sqrt(2 * cape);
        stormHeight = calculateStormHeight(cape);
        airDensity = calculateAirDensity(stormHeight);
        dragFactor = 1 - (dragCoefficient * airDensity * stormHeight / dragScalingConstant);
        dragFactor = Math.max(0, dragFactor);
      } else {
        stormHeight = 4000;
        wIdeal = undefined;
        dragFactor = 1;
      }
      let wEff = (wIdeal !== undefined) ? efficiency * wIdeal * dragFactor : undefined;
      return { wEff, stormHeight, dragFactor };
    }

    // Haversine formula to compute horizontal distance (in meters)
    function haversine(lat1, lon1, lat2, lon2) {
      const R_earth = 6371000; // radius in meters
      let dLat = degToRad(lat2 - lat1);
      let dLon = degToRad(lon2 - lon1);
      let a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(degToRad(lat1)) * Math.cos(degToRad(lat2)) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
      let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R_earth * c;
    }

    /************************************************************
     * Main Calculation Logic
     ************************************************************/
    document.getElementById("calcButton").addEventListener("click", function () {
      // Get primary input strings
      let capeStr = document.getElementById("cape").value.trim();
      let shearStr = document.getElementById("shear").value.trim();
      let angleStr = document.getElementById("angle").value.trim();
      let strikesStr = document.getElementById("strikes").value.trim();

      // Check unknown options for primary inputs
      let capeUnknown = document.getElementById("capeUnknown").checked;
      let shearUnknown = document.getElementById("shearUnknown").checked;
      let angleUnknown = document.getElementById("angleUnknown").checked;

      let providedCAPE = (!capeUnknown && capeStr !== "") ? parseFloat(capeStr) : undefined;
      let providedShear = (!shearUnknown && shearStr !== "") ? parseFloat(shearStr) : undefined;
      let providedAngle = (!angleUnknown && angleStr !== "") ? parseFloat(angleStr) : undefined;

      // Count how many of the three are provided
      let count = 0;
      if (providedCAPE !== undefined) count++;
      if (providedShear !== undefined) count++;
      if (providedAngle !== undefined) count++;

      if (count !== 2) {
        alert("Please ensure that exactly two of the three inputs (CAPE, Shear, and Angle) are known.");
        return;
      }

      // Parse lightning strikes (default 50)
      let strikesPerMinute = strikesStr !== "" ? parseInt(strikesStr) : 50;
      if (strikesPerMinute < 0) {
        alert("Lightning strikes per minute must be non-negative.");
        return;
      }

      // Compute efficiency factor α
      let maxEfficiency = 0.9;
      let efficiency = Math.min(strikesPerMinute / 100, maxEfficiency);

      // Initialize computed values
      let computedCAPE = providedCAPE;
      let computedShear = providedShear;
      let computedAngle = providedAngle; // in degrees

      // Case 1: Missing Angle
      if (providedAngle === undefined) {
        let { wEff } = computeEffectiveUpdraft(providedCAPE, efficiency);
        if (!wEff) {
          alert("Effective updraft speed is zero, cannot solve for angle.");
          return;
        }
        let shear_ms = providedShear / mpsToKnots;
        let tanAngle = shear_ms / wEff;
        computedAngle = radToDeg(Math.atan(tanAngle));
      }
      // Case 2: Missing Shear
      else if (providedShear === undefined) {
        let { wEff } = computeEffectiveUpdraft(providedCAPE, efficiency);
        let angleRad = degToRad(providedAngle);
        let shear_ms = wEff * Math.tan(angleRad);
        computedShear = shear_ms * mpsToKnots;
      }
      // Case 3: Missing CAPE
      else if (providedCAPE === undefined) {
        let angleRad = degToRad(providedAngle);
        let shear_ms = providedShear / mpsToKnots;
        let defaultStormHeight = 4000;
        let airDensityDefault = calculateAirDensity(defaultStormHeight);
        let dragFactorDefault = 1 - (dragCoefficient * airDensityDefault * defaultStormHeight / dragScalingConstant);
        dragFactorDefault = Math.max(0, dragFactorDefault);
        let sqrtTerm = shear_ms / (efficiency * dragFactorDefault * Math.tan(angleRad));
        computedCAPE = Math.pow(sqrtTerm, 2) / 2;
      }

      // Now, if CAPE is known, compute effective updraft and storm height.
      let finalUpdraft;
      let finalStormHeight;
      if (computedCAPE !== undefined) {
        let result = computeEffectiveUpdraft(computedCAPE, efficiency);
        finalUpdraft = result.wEff;
        finalStormHeight = result.stormHeight;
      } else {
        finalUpdraft = undefined;
        finalStormHeight = 4000;
      }

      // ---- Optional: Use Geographic Data for Storm Height and Rotation ----
      let geoHeightComputed = false;
      // Check if geographic fields are provided (and not marked unknown)
      let stormLatStr = document.getElementById("stormLat").value.trim();
      let stormLonStr = document.getElementById("stormLon").value.trim();
      let observerLatStr = document.getElementById("observerLat").value.trim();
      let observerLonStr = document.getElementById("observerLon").value.trim();
      let elevAngleStr = document.getElementById("elevAngle").value.trim();

      let stormLatUnknown = document.getElementById("stormLatUnknown").checked;
      let stormLonUnknown = document.getElementById("stormLonUnknown").checked;
      let observerLatUnknown = document.getElementById("observerLatUnknown").checked;
      let elevAngleUnknown = document.getElementById("elevAngleUnknown").checked;

      if (!stormLatUnknown && !stormLonUnknown && !observerLatUnknown && stormLatStr !== "" && stormLonStr !== "" && observerLatStr !== "") {
        let stormLat = parseFloat(stormLatStr);
        let stormLon = parseFloat(stormLonStr);
        let observerLat = parseFloat(observerLatStr);
        let observerLon = observerLonStr !== "" ? parseFloat(observerLonStr) : 0;
        let horizontalDistance = haversine(observerLat, observerLon, stormLat, stormLon);
        
        // If elevation angle (from observer) is provided, use it to compute storm height
        if (!elevAngleUnknown && elevAngleStr !== "") {
          let elevAngle = parseFloat(elevAngleStr);
          // Assume elevation angle is measured from horizontal
          let trigStormHeight = horizontalDistance * Math.tan(degToRad(elevAngle));
          finalStormHeight = trigStormHeight;
          geoHeightComputed = true;
        }
        
        // Also compute the Coriolis parameter from observer latitude:
        let f = 2 * Omega * Math.sin(degToRad(observerLat));
        // Compute a rotational shear contribution: using effective updraft-derived Uₑff = w * tan(angle)
        let Ueff = (finalUpdraft !== undefined && computedAngle !== undefined) ? finalUpdraft * Math.tan(degToRad(computedAngle)) : 0;
        // Let k=1 as a default weighting factor
        let rotationalShear = f * Ueff;
        // We'll output this additional rotational shear
        document.getElementById("rotationShear").textContent = round(rotationalShear, 4) + " s⁻¹ (rotational contribution)";
      } else {
        document.getElementById("rotationShear").textContent = "Not computed (insufficient geographic data)";
      }
      // -----------------------------------------------------------------------

      // Display results.
      if (computedCAPE !== undefined)
        document.getElementById("capeVal").textContent = round(computedCAPE, 2);
      else
        document.getElementById("capeVal").textContent = "Not provided (computed)";
      
      if (computedShear !== undefined)
        document.getElementById("shearVal").textContent = round(computedShear, 2);
      else
        document.getElementById("shearVal").textContent = "Not provided (computed)";
      
      if (computedAngle !== undefined)
        document.getElementById("angleVal").textContent = round(computedAngle, 2);
      else
        document.getElementById("angleVal").textContent = "Not provided (computed)";
      
      document.getElementById("efficiency").textContent = round(efficiency * 100, 2) + "%";
      document.getElementById("heightVal").textContent = round(finalStormHeight, 2) + (geoHeightComputed ? " (trig.)" : "");
      
      if (finalUpdraft !== undefined) {
        document.getElementById("updraft_mps").textContent = round(finalUpdraft, 2);
        document.getElementById("updraft_knots").textContent = round(finalUpdraft * mpsToKnots, 2);
        document.getElementById("updraft_kmph").textContent = round(finalUpdraft * mpsToKmph, 2);
      } else {
        document.getElementById("updraft_mps").textContent = "N/A";
        document.getElementById("updraft_knots").textContent = "N/A";
        document.getElementById("updraft_kmph").textContent = "N/A";
      }
      
      let explanationText = "Using the relationships:<br>" +
        "<span class='formula'>w = α × √(2 × CAPE) × D</span><br>" +
        "and<br>" +
        "<span class='formula'>Uₑff = w × tan(θ)</span><br><br>" +
        "The missing parameter was computed accordingly.";
      
      document.getElementById("explanation").innerHTML = explanationText;
      document.getElementById("result").style.display = "block";
    });
  </script>
</body>
</html>
