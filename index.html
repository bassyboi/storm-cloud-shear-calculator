<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Storm Shear & CAPE Calculator</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 2rem;
      background-color: #f0f8ff;
      line-height: 1.6;
    }
    .container {
      background: #fff;
      padding: 2rem;
      border-radius: 10px;
      max-width: 800px;
      margin: auto;
      box-shadow: 0px 0px 15px rgba(0,0,0,0.1);
    }
    h1, h2 {
      text-align: center;
      color: #333;
    }
    h3 {
      color: #444;
    }
    label {
      display: block;
      margin-top: 1.2rem;
      color: #333;
    }
    input[type="number"] {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    button {
      display: block;
      width: 100%;
      padding: 0.8rem;
      background: #007acc;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 1.5rem;
      transition: background 0.3s;
    }
    button:hover {
      background: #005fa3;
    }
    .result {
      margin-top: 1.5rem;
      padding: 1.2rem;
      background: #e9f5ff;
      border: 1px solid #b3d7ff;
      border-radius: 8px;
    }
    .formula {
      background: #eef;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-family: monospace;
      display: inline-block;
      margin: 0.2rem 0;
    }
    .info {
      background: #fff8dc;
      padding: 1rem;
      border: 1px solid #f4e1a1;
      border-radius: 8px;
      margin-top: 1.5rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Storm Shear, Updraft & CAPE Calculator</h1>
    
    <div class="info">
      <p>
        Enter <strong>CAPE (J/kg)</strong> and <strong>Storm Tilt Angle</strong> to compute Shear (and updraft speed), <br>
        <em>OR</em> enter <strong>Shear</strong> and <strong>Storm Tilt Angle</strong> to compute CAPE (and updraft speed).
      </p>
      <p style="color:red;"><strong>Note:</strong> If you enter both CAPE <em>and</em> Shear, the calculator will default to using CAPE and ignore the shear value.</p>
      <p>We assume a default <strong>storm height</strong> (\(\Delta z\)) of <strong>6000 m</strong>.</p>
    </div>

    <!-- Inputs Section -->
    <h2>Inputs</h2>
    <label for="cape">CAPE (J/kg):</label>
    <input type="number" id="cape" placeholder="Enter CAPE (J/kg)" step="any" />

    <label for="shear">Bulk Wind Shear (S in 1/s):</label>
    <input type="number" id="shear" placeholder="Enter shear (s⁻¹)" step="any" />

    <label for="angle">Storm Tilt Angle (θ in degrees):</label>
    <input type="number" id="angle" placeholder="Enter storm tilt angle" step="any" />

    <button id="calcButton">Calculate Parameters</button>

    <!-- Results Section -->
    <div id="result" class="result" style="display:none;">
      <h2>Results</h2>
      
      <p><strong>CAPE (derived or entered):</strong> <span id="capeResult"></span> J/kg</p>
      
      <p><strong>Estimated Updraft Speed (w):</strong></p>
      <ul>
        <li><span id="updraft_mps"></span> m/s</li>
        <li><span id="updraft_knots"></span> knots</li>
        <li><span id="updraft_kmph"></span> km/h</li>
      </ul>
      
      <p><strong>Effective Advective Wind (U<sub>eff</sub>):</strong></p>
      <ul>
        <li><span id="wind_mps"></span> m/s</li>
        <li><span id="wind_knots"></span> knots</li>
        <li><span id="wind_kmph"></span> km/h</li>
      </ul>
      
      <p><strong>Bulk Wind Shear (S):</strong> <span id="shearResult"></span> s<sup>-1</sup></p>
      
      <p id="explanation"></p>
    </div>
  </div>

  <script>
    // Conversion factors
    const mpsToKnots = 1.94384;
    const mpsToKmph = 3.6;
    const defaultDeltaZ = 6000; // 6000 m vertical separation
    
    function degToRad(deg) {
      return deg * (Math.PI / 180);
    }
    
    function round(value, decimals) {
      return Number(Math.round(value + 'e' + decimals) + 'e-' + decimals);
    }
    
    document.getElementById("calcButton").addEventListener("click", function() {
      // Get inputs
      let capeInput = document.getElementById("cape").value.trim();
      let shearInput = document.getElementById("shear").value.trim();
      let angleDeg   = parseFloat(document.getElementById("angle").value.trim());
      
      // Basic validation: user must enter an angle
      if (isNaN(angleDeg)) {
        alert("Please enter a valid storm tilt angle (in degrees).");
        return;
      }
      // Also check that angle is not 0 if we want to do valid tan(θ) in case of shear-based method
      if (angleDeg === 0 && shearInput) {
        alert("Tilt angle cannot be zero when calculating CAPE from shear (division by zero).");
        return;
      }
      
      // Convert angle to radians for calculations
      let angleRad = degToRad(angleDeg);
      
      let w;        // updraft speed (m/s)
      let U_eff;    // effective wind (m/s)
      let S;        // bulk wind shear (1/s)
      let CAPE;     // convective available potential energy (J/kg)
      
      // CASE 1: User provides CAPE (ignore shear if both are present)
      if (capeInput !== "") {
        // parse float
        CAPE = parseFloat(capeInput);
        // Validate that CAPE >= 0
        if (isNaN(CAPE) || CAPE < 0) {
          alert("Please enter a valid non-negative CAPE value.");
          return;
        }
        
        // 1) Updraft speed
        w = Math.sqrt(2 * CAPE);
        
        // 2) Effective wind
        U_eff = w * Math.tan(angleRad);
        
        // 3) Bulk wind shear
        S = (2 * U_eff) / defaultDeltaZ;
        
      } else if (shearInput !== "") {
        // CASE 2: User provides Shear => solve for CAPE
        S = parseFloat(shearInput);
        if (isNaN(S) || S < 0) {
          alert("Please enter a valid non-negative Shear value.");
          return;
        }
        
        // Rearrange S = (2 * sqrt(2*CAPE) * tan(θ)) / Δz to solve for CAPE:
        //   sqrt(2*CAPE) = (S * Δz) / [2 * tan(θ)]
        //   2*CAPE = [ (S * Δz) / (2 * tan(θ)) ]^2
        //   CAPE = 0.5 * [ (S * Δz) / (2 * tan(θ)) ]^2
        let numerator = S * defaultDeltaZ;
        let denominator = 2 * Math.tan(angleRad);
        
        CAPE = 0.5 * Math.pow(numerator / denominator, 2);
        
        // Now that we have CAPE, we can proceed as normal
        w = Math.sqrt(2 * CAPE);
        U_eff = w * Math.tan(angleRad);
        
      } else {
        // If neither CAPE nor shear was provided
        alert("Please enter either a CAPE value or a Shear value.");
        return;
      }
      
      // Now we have w, U_eff, S, and CAPE. Let's do unit conversions for w and U_eff:
      let w_knots = w * mpsToKnots;
      let w_kmph  = w * mpsToKmph;
      
      let Ueff_knots = U_eff * mpsToKnots;
      let Ueff_kmph  = U_eff * mpsToKmph;
      
      // Insert results into the page
      document.getElementById("capeResult").textContent       = round(CAPE, 2);
      document.getElementById("updraft_mps").textContent      = round(w, 2);
      document.getElementById("updraft_knots").textContent    = round(w_knots, 2);
      document.getElementById("updraft_kmph").textContent     = round(w_kmph, 2);
      document.getElementById("wind_mps").textContent         = round(U_eff, 2);
      document.getElementById("wind_knots").textContent       = round(Ueff_knots, 2);
      document.getElementById("wind_kmph").textContent        = round(Ueff_kmph, 2);
      document.getElementById("shearResult").textContent      = round(S, 5);
      
      // Explanation (brief)
      document.getElementById("explanation").innerHTML = 
        "Formulas used:<br>" +
        "<span class='formula'>w = √(2 × CAPE)</span><br>" +
        "<span class='formula'>U<sub>eff</sub> = w × tan(θ)</span><br>" +
        "<span class='formula'>S = (2 × U<sub>eff</sub>) / Δz</span>, where Δz = " + defaultDeltaZ + " m<br>" +
        "If shear was provided, we solved for CAPE by rearranging the equations so that:<br>" +
        "<span class='formula'>CAPE = 0.5 × [ (S × Δz) / (2 × tan(θ)) ]<sup>2</sup></span>";
      
      document.getElementById("result").style.display = "block";
    });
  </script>
</body>
</html>
